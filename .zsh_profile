export LDFLAGS=-L/usr/local/opt/zlib/lib
export CPPFLAGS=-I/usr/local/opt/zlib/include
export CFLAGS=-I$(xcrun --show-sdk-path)/usr/include

export GPG_TTY=$(tty)

export PYENV_ROOT=$HOME/.pyenv
export GOPATH=$HOME/go

export PATH=/usr/local/opt/openssl@1.1/bin:$PYENV_ROOT/shims:$PYENV_ROOT/bin:$GOPATH/bin:/usr/local/lib/ruby/gems/2.7.0/bin:/usr/local/opt/sqlite/bin:$PATH

export PACKER_CACHE_DIR=$HOME/packer_cache

export SPACESHIP_VENV_SHOW=false
# export SPACESHIP_DOCKER_SHOW=true
export SPACESHIP_DOCKER_CONTEXT_SHOW=false

export AWS_PAGER=""

export PYENV_VIRTUALENV_DISABLE_PROMPT=true
if command -v pyenv 1>/dev/null 2>&1; then
  eval "$(pyenv init -)"
  eval "$(pyenv virtualenv-init -)"
fi


##########
# NeoVim #
##########

# -------
# Aliases
# -------
alias vi='nvim'
alias vim='nvim'


#######
# SSH #
#######

# ---------
# Functions
# ---------

# Delete Known Host (by line number)
dkh() {
  sed -i.bak -e "$1d" ~/.ssh/known_hosts
}

sox-ssh () {
  ssh -D 8080 $1
}

vnc-ssh () {
  ssh $1 -L 5901:127.0.0.1:5901
}


##############
# Networking #
##############

# -------
# Aliases
# -------
alias refresh-dns='sudo killall -HUP mDNSResponder'

# ---------
# Functions
# ---------

subnet-scan () {
  nmap -sP $1
}

sox () {
  sox_help() { echo "Helper utility to toggle the MacOS SOCKS proxy. Pass on or off to set proxy state." }

  case "$1" in
  on*|off*)
    networksetup -setsocksfirewallproxystate Wi-Fi $1
    echo "SOCKS proxy has been turned $1"
    ;;
  *)
    sox_help
    ;;
  esac
}

# Listen on udp socket and print
los() {
  nc -u -l $1
}


#######
# AWS #
#######

# -------
# Aliases
# -------

alias ec2ls="aws ec2 describe-instances --query 'sort_by(Reservations[].Instances[].{Name:Tags[?Key==\`Name\`]|[0].Value, Environment:Tags[?Key==\`Environment\`]|[0].Value, Purpose:Tags[?Key==\`Purpose\`]|[0].Value, ID:InstanceId, AZ:Placement.AvailabilityZone, PrivateIP:PrivateIpAddress, PublicIP:PublicIpAddress, State:State.Name}, &Name)' --output table --region"
alias ec2-reboot="aws ec2 reboot-instances"

# ---------
# Functions
# ---------
awssh () {
  ssh -l admin -F ssh.config $1
}

# AWS Account (Easily switch between profiles)
awsacc () {
  if [ -z "$1" ]; then
    echo $AWS_PROFILE
  elif [ "$1" = "ls" ]; then
    grep '\[*\]' ~/.aws/credentials
  else
    export AWS_PROFILE="$1"
  fi
}

awsid () {
  aws ec2 describe-security-groups --group-names 'Default' --query 'SecurityGroups[0].OwnerId' --output text --region us-east-1
}

# Get Private IP of EC2 Instance by name
awsip () {
  aws ec2 describe-instances --filters Name=tag:Name,Values=$1 --query "Reservations[].Instances[].PrivateIpAddress" --region $2 --output text
}

# EC2 Describe by name
ec2d () {
  aws ec2 describe-instances --filters Name=tag:Name,Values=$1 --query "Reservations[].Instances[]" --region $2 --output table
}

aws-tag() {
  help() {
    echo "Tag an AWS resource"
    echo "Args:"
    echo "  1. AWS region"
    echo "  2. Resource ID"
    echo "  3. Tag Name"
    echo "  4. Tag Value"
  }
  if [ -z "$4" ]; then
    help
  else
    aws ec2 create-tags --region $1 --resources $2 --tags "Key=$3,Value=$4"
  fi
}

aws-untag() {
  help() {
    echo "Untag an AWS resource"
    echo "Args:"
    echo "  1. AWS region"
    echo "  2. Resource ID"
    echo "  3. Tag Name"
  }
  if [ -z "$3" ]; then
    help
  else
    aws ec2 delete-tags --region $1 --resources $2 --tags "Key=$3"
  fi
}

ec2-inspect() {
  help() {
    echo "Describe an EC2 instance"
    echo "Args:"
    echo "  1. AWS region"
    echo "  2. EC2 ID"
  }
  if [ -z "$2" ]; then
    help
  else
    aws ec2 describe-instances --filters "Name=instance-id,Values=$2" --output table --region $1
  fi
}

# Generate Password
gpw() {
  pwgen -Bsy $1 1 |pbcopy |pbpaste; echo “Has been copied to clipboard”
}


##########
# Docker #
##########

# -------
# Aliases
# -------
# Docker aliases
alias start-docker='open --background -a Docker'
alias stop-docker='test -z "$(docker ps -q 2>/dev/null)" && osascript -e "quit app \"Docker\""'
alias dic='docker rmi $(docker images --filter "dangling=true" -q)'
alias drd9='docker run -it --rm debian:9'
alias drd10='docker run -it --rm debian:10'
alias drc8='docker run -it --rm centos:8'

# Docker compose aliases
alias dkc='docker-compose'
alias dkcu='dkc up'
alias dkcd='dkc down'
alias dkcp='dkc ps'

# ---------
# Functions
# ---------
docker-shell() {
  container=`docker container ls | sed -n 2p | awk '{print $1}'`
  docker exec -it $container /bin/bash
}

docker-ip() {
  docker inspect --format '{{ .NetworkSettings.IPAddress }}' "$@"
}


##########
# Python #
##########

# ---------
# Functions
# ---------
# Install cwd's requirements.txt into venvs used for deoplete
# NOTE: This function assumes the venvs being used for deoplete for python2 and 3
#       are named 'nvim2' and 'nvim3' respectively. This can be set in your nvim
#       config.
venv-init() {
  ~/.pyenv/versions/2.7.10/envs/nvim2/bin/pip install -r requirements.txt
  ~/.pyenv/versions/3.8.1/envs/nvim3/bin/pip install -r requirements.txt
}


###########
# OpenSSL #
###########

# -------
# Aliases
# -------
alias read-csr='openssl req -text -noout -verify -in'
alias read-cert='openssl x509 -noout -text -in'
alias cert-serial='openssl x509 -serial -noout -in'
alias encrypt-file='openssl enc -aes-256-cbc -salt -in file.txt -out file.txt.enc'
alias decrypt-file='openssl enc -aes-256-cbc -d -in file.txt.enc -out file.txt'

# ---------
# Functions
# ---------
# Generate an aes key w/ openssl
aes-key() {
  openssl rand -out out.key 32
}

# Wrap an aes key with a given RSAES OAEP SHA1 wrapping key
wrap-aes-key() {
  openssl rsautl -encrypt -in $1 -oaep -inkey $2 -pubin -keyform DER -out $1.enc
}

gen-priv-key() {
  help() {
    echo "Create a private key using OpenSSL with either RSA (default) or ECC (secp384r1)"
    echo "Args:"
    echo "  1. The name of the key to create"
    echo "  2. The type of key to create (optional)"
  }

  if [ -z "$2" ]; then
    TYPE="rsa"
  else
    TYPE=$2
  fi

  NAME=$1

  if [ -z "$NAME" ]; then
    help
  fi

  if [ "$TYPE" = "rsa" ]; then
    openssl genrsa -out $NAME 4096
  elif [ "$TYPE" = "ecc" ]; then
    openssl ecparam -out $NAME -name secp384r1 -genkey
  else
    help
  fi
}

# TODO: Make this function less stupid
encrypt-priv-key() {
  help() {
    echo "Encrypt an OpenSSL private key with a passphrase"
    echo "Args:"
    echo "  1. The path of the file to encrypt"
    echo "  2. The type of key we're encrypting (ecc or rsa) *Defaults to rsa*"
  }

  if [ -z "$2" ]; then
    TYPE="rsa"
  else
    TYPE=$2
  fi

  if [ -z "$1" ]; then
    help
  else
    if [ "$TYPE" = "ecc" ]; then
      openssl ec -in $1 -out $1 -aes256
    else
      openssl $TYPE -in $1 -out $1 -aes256
    fi
  fi
}

gen-csr() {
  help() {
    echo "Create a CSR using OpenSSL"
    echo "Args:"
    echo "  1. Path to private key"
    echo "  2. Path to create the csr file"
    echo "  3. Path to openssl.cnf"
  }

  KEY=$1
  CSR=$2
  CNF=$3

  if [ -z "$KEY" ] || [ -z "$CSR" ] || [ -z "$CNF" ]; then
    help
  else
    openssl req -new -key $KEY -out $CSR -config $CNF -sha384
  fi
}


###########
# Vagrant #
###########

# -------
# Aliases
# -------
alias vu='vagrant up'
alias vr='vd && vu'
alias vd='vagrant destroy -f'
alias vp='vagrant provision'
alias vs='vagrant status'
alias vss='vagrant ssh'
alias vgs='vagrant global-status'
alias vagrant destroy='vagrant destroy -f'


############
# Molecule #
############

# -------
# Aliases
# -------
alias ml='molecule login'
alias mt='molecule test'
alias mc='molecule converge'
alias md='molecule destroy --all'


#############
# Terraform #
#############

# -------
# Aliases
# -------
alias tf='terraform'


########
# Misc #
########

# -------
# Aliases
# -------

alias get_top_open_files="lsof | awk '{print $1}' | uniq -c | sort -rn | head"

# Traversal aliases
alias cd..='cd ..'
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'

# Stuff that should be in my git config
alias git a='git add -A'
alias git cm='git commit -am'

alias c='clear'
alias mkdir='mkdir -pv'
alias now='date +"%T"'
alias pgadmin='open /Applications/pgAdmin\ 4.app'
alias t=todolist
alias jcat='python -m json.tool'
alias ping='/sbin/ping -c 3'
alias grip='~/.pyenv/versions/grip/bin/grip'

# Nonsense
alias shrug='echo "¯\_(ツ)_/¯"'
alias weather='curl wttr.in'
alias party='curl parrot.live'

# ---------
# Functions
# ---------
cheat () {
  cheat_help() {
    echo "curl cht.sh! but be lazy about it..."
    echo "Along with the command 'cheat', enter the programming language you're dealing with, and you question."
    echo "Example: cheat bash 'what are computers'"
  }

  CHEAT_LANG=$1
  CHEAT_QUESTION="${@:2}"

  if [ -z "$CHEAT_LANG" ] || [ -z "$CHEAT_QUESTION" ]; then
    cheat_help
  else
    echo "curling cht.sh/$CHEAT_LANG/${CHEAT_QUESTION// /+}"
    curl cht.sh/$CHEAT_LANG/${CHEAT_QUESTION// /+}
  fi
}

ulimit -n 4096
